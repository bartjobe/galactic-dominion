<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Galaxie Vivante ‚Äî V5 Ressources</title>

  <!-- React 17 + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,body { height:100%; margin:0; background: radial-gradient(ellipse at bottom, #020419 0%, #00030a 60%, #000 100%); color:#e6f0ff; font-family:Inter, system-ui; overflow:hidden; }
    #root { width:100%; height:100vh; position:relative; }
    .star { transition: transform 0.12s, box-shadow 0.12s; will-change: transform; }
    .star:hover { transform: scale(1.28); z-index:80; }
    .halo { filter: blur(6px) saturate(120%); opacity:0.9; }
    .notif { animation: pop .35s ease-out; }
    @keyframes pop { from { transform: translateY(8px); opacity:0 } to { transform: translateY(0); opacity:1 } }
    .journal::-webkit-scrollbar { width:8px }
    .journal::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius:8px }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const rand = (a,b)=>Math.random()*(b-a)+a;
  const randint=(a,b)=>Math.floor(rand(a,b+1));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const now=()=>Date.now();
  const WORLD={SIZE:3400,BASE_COUNT:32};
  const syll=["zor","kan","vel","tor","lin","rax","mer","ion","tal","quor","xen","phi","lun","dra","ora","esh","nar","sol","vak"];
  const randomName=()=>syll[Math.floor(Math.random()*syll.length)]+syll[Math.floor(Math.random()*syll.length)]+"-"+randint(1,999);
  const nextId=(()=>{let i=0;return()=> 'S'+(++i);})();

  function generateStar(){
    const lvl=randint(0,3);
    const aligns=['pacifique','conqu√©rant','nomade','scientifique','isolationniste'];
    const align=aligns[randint(0,aligns.length-1)];
    return {
      id: nextId(),
      name: randomName(),
      x: Math.floor(rand(80,WORLD.SIZE-80)),
      y: Math.floor(rand(80,WORLD.SIZE-80)),
      population: Math.floor(rand(10000,2500000)),
      civLevel: lvl,
      alignment: align,
      energy: Math.floor(rand(120,700)),
      status: 'stable',
      relations: {},
      lastEvent: null,
      owner: null
    };
  }

  function createGalaxy(n=WORLD.BASE_COUNT){
    const arr=[];
    for(let i=0;i<n;i++) arr.push(generateStar());
    for(const a of arr){
      for(const b of arr){
        if(a.id===b.id) continue;
        const d=Math.hypot(a.x-b.x,a.y-b.y);
        a.relations[b.id]=Math.floor(clamp(100-d/40+rand(-10,10),-80,100));
      }
    }
    return arr;
  }

  function evolveGalaxy(galaxy,hours){
    return galaxy.map(s=>{
      const ns={...s};
      let baseGrowth=1+0.0008*(ns.civLevel+1);
      if(ns.status==='expansion') baseGrowth+=0.01;
      if(ns.status==='war') baseGrowth-=0.02;
      ns.population=Math.max(0,Math.floor(ns.population*Math.pow(1+(baseGrowth-1),hours)));
      ns.energy=Math.max(0,Math.floor(ns.energy+(hours*randint(-5,10))));
      if(Math.random()<0.015*hours*(1+ns.civLevel/8)) ns.civLevel=Math.min(6,ns.civLevel+1);
      if(Math.random()<0.012*hours){
        const r=Math.random();
        ns.status=r<0.5?'stable':r<0.8?'expansion':'unrest';
      }
      if(Math.random()<0.0007*hours){
        ns.status='collapsed';
        ns.population=Math.floor(ns.population*0.08);
      }
      ns.lastEvent=`√âvolution ${hours}h`;
      return ns;
    });
  }

  function GalaxyMap({ galaxy,onSelect,camera,setCamera,highlighted }){
    const ref=useRef(null);
    const dragging=useRef(false);
    const last=useRef({x:0,y:0});
    useEffect(()=>{
      const el=ref.current;
      if(!el) return;
      const onWheel=(e)=>{
        e.preventDefault();
        const delta=-e.deltaY;
        const zoomFactor=delta>0?1.08:0.92;
        const rect=el.getBoundingClientRect();
        const mx=e.clientX-rect.left,my=e.clientY-rect.top;
        const worldX=(mx-camera.x)/camera.scale, worldY=(my-camera.y)/camera.scale;
        const newScale=clamp(camera.scale*zoomFactor,0.35,2.2);
        const nx=mx-worldX*newScale, ny=my-worldY*newScale;
        setCamera(prev=>({...prev,scale:newScale,x:nx,y:ny}));
      };
      el.addEventListener('wheel',onWheel,{passive:false});
      return()=>el.removeEventListener('wheel',onWheel);
    },[camera,setCamera]);
    const onPointerDown=e=>{dragging.current=true;last.current={x:e.clientX,y:e.clientY};};
    const onPointerMove=e=>{
      if(!dragging.current)return;
      const dx=e.clientX-last.current.x,dy=e.clientY-last.current.y;
      last.current={x:e.clientX,y:e.clientY};
      setCamera(c=>({...c,x:c.x+dx,y:c.y+dy}));
    };
    const onPointerUp=()=>{dragging.current=false;};
    const transform=`translate(${camera.x}px,${camera.y}px) scale(${camera.scale})`;
    return (
      <div ref={ref} className="absolute inset-0" onPointerDown={onPointerDown} onPointerMove={onPointerMove} onPointerUp={onPointerUp} style={{touchAction:'none'}}>
        <div style={{
          position:'absolute',left:(window.innerWidth-WORLD.SIZE)/2,top:(window.innerHeight-WORLD.SIZE)/2,
          width:WORLD.SIZE,height:WORLD.SIZE,transform,transformOrigin:'0 0',transition:dragging.current?'none':'transform 0.06s'
        }}>
          {[...Array(120)].map((_,i)=>
            <div key={i} style={{position:'absolute',left:rand(0,WORLD.SIZE),top:rand(0,WORLD.SIZE),width:Math.random()*2+0.5,height:Math.random()*2+0.5,borderRadius:999,background:'rgba(255,255,255,0.05)'}}/>
          )}
          {galaxy.map(s=>{
            const size=clamp(6+Math.log10(Math.max(1,s.population))/1.05,6,40);
            const alignHue=s.alignment==='conqu√©rant'?'#ffb86b':s.alignment==='scientifique'?'#b4a7ff':s.alignment==='pacifique'?'#6ee7b7':s.alignment==='nomade'?'#ffd86b':'#9aa6ff';
            const color=s.status==='collapsed'?'#555':alignHue;
            const haloSize=size*(1+(s.civLevel/8));
            const border=s.owner?'2px solid rgba(255,255,255,0.15)':'1px solid rgba(255,255,255,0.06)';
            return (
              <div key={s.id} className="star" onClick={(e)=>{e.stopPropagation();onSelect(s);}} title={`${s.name} ‚Ä¢ civ ${s.civLevel}`} style={{
                position:'absolute',left:s.x-size/2,top:s.y-size/2,width:size,height:size,borderRadius:999,background:color,
                display:'flex',alignItems:'center',justifyContent:'center',fontSize:Math.min(14,size-4),fontWeight:800,color:'#021',cursor:'pointer',border
              }}>
                <div className="halo" style={{position:'absolute',left:-((haloSize-size)/2),top:-((haloSize-size)/2),width:haloSize,height:haloSize,borderRadius:999,background:color,opacity:0.06,zIndex:-1}}/>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  const BASE_BUILDINGS={
    mine:{name:"Mine",cost:50,baseProd:2,resType:"minerai"},
    power:{name:"Centrale",cost:75,baseProd:3,resType:"energie"},
    extractor:{name:"Extracteur",cost:100,baseProd:1,resType:"cristal"},
    lab:{name:"Laboratoire",cost:150,baseProd:0.5,resType:"science"},
  };

  function HUD({resources}){
    return (
      <div className="text-xs text-gray-200 space-y-1">
        <div>‚õèÔ∏è Minerai : {Math.floor(resources.minerai)}</div>
        <div>‚ö° √ânergie : {Math.floor(resources.energie)}</div>
        <div>üíé Cristal : {Math.floor(resources.cristal)}</div>
        <div>üß™ Science : {Math.floor(resources.science)}</div>
      </div>
    );
  }

  function PlanetPanel({selectedStar,buildings,resources,onBuild}){
    if(!selectedStar)return null;
    return (
      <div className="mt-2 text-xs text-gray-200 space-y-1">
        <h3 className="text-sm font-bold text-cyan-300">üåç {selectedStar.name}</h3>
        {Object.entries(BASE_BUILDINGS).map(([key,b])=>(
          <button key={key} onClick={()=>onBuild(key,b.cost)} disabled={resources.minerai<b.cost}
            className="block w-full my-1 px-2 py-1 bg-slate-700 rounded disabled:opacity-40">
            {b.name} (Co√ªt {b.cost})
          </button>
        ))}
        <div className="mt-2">
          {Object.entries(buildings).map(([k,v])=><div key={k}>{BASE_BUILDINGS[k].name}: {v}</div>)}
        </div>
      </div>
    );
  }

  function App(){
    const [galaxy,setGalaxy]=useState([]);
    const [selected,setSelected]=useState(null);
    const [log,setLog]=useState([]);
    const [notif,setNotif]=useState(null);
    const [camera,setCamera]=useState({x:0,y:0,scale:0.95});
    const [highlighted,setHighlighted]=useState(null);

    const [resources,setResources]=useState({minerai:100,energie:100,cristal:50,science:0});
    const [buildings,setBuildings]=useState({mine:0,power:0,extractor:0,lab:0});

    useEffect(()=>{setGalaxy(createGalaxy());setLog(["Nouvelle galaxie g√©n√©r√©e."]);},[]);

    useEffect(()=>{const t=setInterval(()=>{setResources(r=>({
      ...r,
      minerai:r.minerai+buildings.mine*BASE_BUILDINGS.mine.baseProd,
      energie:r.energie+buildings.power*BASE_BUILDINGS.power.baseProd,
      cristal:r.cristal+buildings.extractor*BASE_BUILDINGS.extractor.baseProd,
      science:r.science+buildings.lab*BASE_BUILDINGS.lab.baseProd,
    }));},3000);return()=>clearInterval(t);},[buildings]);

    function handleBuild(type,cost){
      if(resources.minerai>=cost){
        setResources(r=>({...r,minerai:r.minerai-cost}));
        setBuildings(b=>({...b,[type]:b[type]+1}));
        setNotif(`${BASE_BUILDINGS[type].name} construit`);
      } else setNotif("Pas assez de minerai !");
    }

    const pushLog=t=>setLog(l=>[`${new Date().toLocaleTimeString()} ‚Äî ${t}`,...l].slice(0,200));

    return (
      <div className="w-full h-full relative select-none">
        <div className="absolute top-3 left-3 text-cyan-300 text-xl font-bold">üåå La Galaxie Vivante ‚Äî V5</div>

        <GalaxyMap galaxy={galaxy} onSelect={s=>setSelected(s)} camera={camera} setCamera={setCamera} highlighted={highlighted}/>

        <div className="absolute right-4 top-20 w-80 bg-black bg-opacity-60 p-3 rounded">
          <h3 className="font-bold text-cyan-200 mb-2">Fiche Syst√®me</h3>
          {!selected && <div className="text-sm text-gray-300">Clique sur une √©toile pour les d√©tails.</div>}
          {selected && (
            <>
              <div className="text-sm">Nom: {selected.name}</div>
              <div className="text-sm">Population: {selected.population.toLocaleString()}</div>
              <div className="text-sm">Niveau: {selected.civLevel}</div>
              <div className="text-sm">Alignement: {selected.alignment}</div>
              <div className="text-sm">√ânergie: {selected.energy}</div>
            </>
          )}
        </div>

        <div className="absolute bottom-24 right-4 bg-black bg-opacity-60 p-3 rounded w-80">
          <HUD resources={resources}/>
          {selected && <PlanetPanel selectedStar={selected} buildings={buildings} resources={resources} onBuild={handleBuild}/>}
        </div>

        <div className="absolute bottom-4 left-4 bg-black bg-opacity-60 p-3 rounded w-96 max-h-[46vh] overflow-y-auto journal">
          <div className="font-semibold text-cyan-200 mb-1">Journal Galactique</div>
          {log.map((l,i)=><div key={i} className="text-xs mb-1">‚Ä¢ {l}</div>)}
        </div>

        {notif && <div className="absolute top-16 right-6 notif bg-white bg-opacity-10 p-3 rounded text-sm">{notif}</div>}
      </div>
    );
  }

  ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
