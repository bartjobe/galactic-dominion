<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üåå La Galaxie Vivante ‚Äî V7</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,body {
      margin: 0;
      height: 100%;
      background: radial-gradient(ellipse at bottom, #05071a 0%, #000 100%);
      color: #e6f0ff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
      overflow: hidden;
    }
    .star { transition: transform 0.12s, box-shadow 0.12s; cursor: pointer; }
    .star:hover { transform: scale(1.25); }
    .notif { animation: pop .3s ease-out; }
    @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .hud {
      background: rgba(0,0,0,0.6);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.9rem;
      display: flex;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /* ============================================================
     G√âN√âRATION DE LA GALAXIE
  ============================================================ */
  const WORLD = { SIZE: 3200, STAR_COUNT: 28 };
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const randint = (a,b)=>Math.floor(rand(a,b+1));

  const syll = ["zor","kan","vel","tor","lin","rax","mer","ion","tal","quor","xen","phi","lun","dra","ora","esh","nar","sol","vak"];
  const randomName = ()=>syll[randint(0,syll.length-1)] + syll[randint(0,syll.length-1)] + "-" + randint(1,999);

  const generateStar = () => ({
    id: crypto.randomUUID(),
    name: randomName(),
    x: rand(100, WORLD.SIZE-100),
    y: rand(100, WORLD.SIZE-100),
    population: randint(10000, 5000000),
    civLevel: randint(0,4),
    energy: randint(50,500),
    alignment: ["pacifique","conqu√©rant","scientifique","nomade"][randint(0,3)],
    status: "stable",
    owner: null,
    resources: { minerai: randint(50,200), cristal: randint(20,100), science: 0 },
    buildings: { mine: 0, power: 0, lab: 0 },
  });

  const createGalaxy = () => Array.from({length: WORLD.STAR_COUNT}, generateStar);

  /* ============================================================
     COMPOSANTS DE BASE
  ============================================================ */
  function HUD({ resources }) {
    return (
      <div className="hud absolute top-3 left-3 z-50">
        <div>‚õèÔ∏è Minerai: {Math.floor(resources.minerai)}</div>
        <div>‚ö° √ânergie: {Math.floor(resources.energie)}</div>
        <div>üíé Cristal: {Math.floor(resources.cristal)}</div>
        <div>üß™ Science: {Math.floor(resources.science)}</div>
      </div>
    );
  }

  function StarMap({ galaxy, onSelect, camera, setCamera }) {
    const ref = useRef(null);
    const dragging = useRef(false);
    const last = useRef({x:0,y:0});

    const onDown = (e)=>{dragging.current=true; last.current={x:e.clientX,y:e.clientY};};
    const onMove = (e)=>{ if(!dragging.current)return; const dx=e.clientX-last.current.x; const dy=e.clientY-last.current.y; last.current={x:e.clientX,y:e.clientY}; setCamera(c=>({...c,x:c.x+dx,y:c.y+dy})); };
    const onUp = ()=>dragging.current=false;

    const transform=`translate(${camera.x}px,${camera.y}px) scale(${camera.scale})`;

    return (
      <div ref={ref} onMouseDown={onDown} onMouseMove={onMove} onMouseUp={onUp}
           className="absolute inset-0" style={{touchAction:"none"}}>
        <div style={{
          position:"absolute", left:(window.innerWidth-WORLD.SIZE)/2, top:(window.innerHeight-WORLD.SIZE)/2,
          width:WORLD.SIZE, height:WORLD.SIZE, transform, transformOrigin:"0 0"
        }}>
          {galaxy.map(s=>{
            const size = 6 + Math.log10(s.population)/1.2;
            const color = s.status==="collapsed" ? "#555" :
              s.alignment==="pacifique"?"#6ee7b7":s.alignment==="scientifique"?"#9f9fff":s.alignment==="nomade"?"#ffd86b":"#ff9f6b";
            return (
              <div key={s.id} className="star absolute rounded-full"
                style={{
                  left:s.x-size/2, top:s.y-size/2, width:size, height:size,
                  background:color, border:s.owner?"1px solid white":"1px solid #333"
                }}
                title={s.name}
                onClick={()=>onSelect(s)}></div>
            );
          })}
        </div>
      </div>
    );
  }

  /* ============================================================
     PANNEAU PLAN√àTE + B√ÇTIMENTS
  ============================================================ */
  const BASE_BUILDINGS = {
    mine: { name: "Mine", cost: 50, prod: { minerai: 3 } },
    power: { name: "Centrale", cost: 70, prod: { energie: 5 } },
    lab: { name: "Laboratoire", cost: 120, prod: { science: 0.5 } },
  };

  function PlanetPanel({ star, onBuild }) {
    if(!star) return <div className="p-3 text-gray-400">S√©lectionne une √©toile.</div>;
    return (
      <div className="p-3">
        <h3 className="font-bold text-cyan-300">{star.name}</h3>
        <p className="text-sm text-gray-300">Population: {star.population.toLocaleString()}</p>
        <p className="text-sm text-gray-300">Alignement: {star.alignment}</p>
        <p className="text-sm text-gray-300">√ânergie: {star.energy}</p>
        <p className="text-sm text-gray-300">B√¢timents:</p>
        {Object.entries(BASE_BUILDINGS).map(([k,b])=>(
          <button key={k} onClick={()=>onBuild(k,b.cost)}
            className="block bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 my-1 w-full text-left text-sm">
            {b.name} (niveau {star.buildings[k]}) ‚Äî co√ªt {b.cost}
          </button>
        ))}
      </div>
    );
  }

  /* ============================================================
     JEU PRINCIPAL
  ============================================================ */
  function App(){
    const [galaxy,setGalaxy]=useState(createGalaxy());
    const [selected,setSelected]=useState(null);
    const [resources,setResources]=useState({minerai:100,energie:100,cristal:50,science:0});
    const [camera,setCamera]=useState({x:0,y:0,scale:0.9});
    const [notif,setNotif]=useState("");

    // production continue
    useEffect(()=>{
      const t=setInterval(()=>{
        const prod={minerai:0,energie:0,science:0};
        galaxy.forEach(s=>{
          for(const [k,b] of Object.entries(s.buildings)){
            const data=BASE_BUILDINGS[k];
            for(const [res,val] of Object.entries(data.prod)){
              prod[res]+=val*b;
            }
          }
        });
        setResources(r=>({...r,minerai:r.minerai+prod.minerai,energie:r.energie+prod.energie,science:r.science+prod.science}));
      },3000);
      return()=>clearInterval(t);
    },[galaxy]);

    function handleBuild(type,cost){
      if(!selected) return;
      if(resources.minerai<cost){ setNotif("Pas assez de minerai !"); return; }
      setResources(r=>({...r,minerai:r.minerai-cost}));
      setGalaxy(g=>g.map(s=>s.id===selected.id?{...s,buildings:{...s.buildings,[type]:s.buildings[type]+1}}:s));
      setNotif(`Construction: ${BASE_BUILDINGS[type].name}`);
    }

    // events dynamiques
    useEffect(()=>{
      const t=setInterval(()=>{
        const i=randint(0,galaxy.length-1);
        const s=galaxy[i];
        const change=Math.floor(s.population*rand(-0.01,0.02));
        setGalaxy(g=>g.map(st=>st.id===s.id?{...st,population:Math.max(0,st.population+change)}:st));
      },8000);
      return()=>clearInterval(t);
    },[galaxy]);

    useEffect(()=>{ if(!notif)return; const t=setTimeout(()=>setNotif(""),3000); return()=>clearTimeout(t); },[notif]);

    return (
      <div className="w-full h-full relative">
        <HUD resources={resources}/>
        <StarMap galaxy={galaxy} onSelect={setSelected} camera={camera} setCamera={setCamera}/>
        <div className="absolute right-3 top-20 bg-black bg-opacity-60 w-72 rounded">
          <PlanetPanel star={selected} onBuild={handleBuild}/>
        </div>
        {notif && <div className="absolute top-16 right-6 bg-white bg-opacity-10 px-3 py-2 rounded notif">{notif}</div>}
        <div className="absolute bottom-3 right-3 text-xs text-gray-400 bg-black bg-opacity-40 px-2 py-1 rounded">
          Zoom/souris: d√©placer ‚Äî cliquez une √©toile pour voir les infos
        </div>
      </div>
    );
  }

  ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
